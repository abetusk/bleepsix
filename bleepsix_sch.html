<html>

  <meta charset='utf-8'>

  <head>

    <!-- we don't want it pausing while loading if the server is down -->
    <script src='js/lib/socket.io.js'></script>  

    <script src='js/lib/union-find.js'></script>
    <script src='js/lib/delaunay.js'></script>
    <script src='js/lib/kruskal.js'></script>
    <script src='js/lib/euclideanmst.js'></script>

    <script src='js/lib/peg.js'></script>

    <script src='js/lib/jquery.js'></script>
    <script src='js/lib/jquery.mousewheel.js'/></script>
    <script src='js/lib/jquery.capslockstate.js'/></script>
    <script src='js/lib/jquery.getUrlParam.js'/></script>

    <script src='js/lib/jquery.fileDownload.js'/></script>

    <script src='js/lib/numeric.js'></script>
    <script src='js/lib/oop.js'></script>
    <script src='js/lib/aux.js'></script>
    <script src='js/lib/jquery.cookie.js'></script>
    <script src='js/lib/peg.js'></script>
    <script src='js/lib/snapGrid.js'></script>

    <script src='js/lib/clipper.js'></script>


    <script src='js/core/bleepsixRender.js'></script>

    <script src='js/sch/bleepsixSchematic.js'></script>
    <script src='js/sch/bleepsixSchematic_net.js'></script>
    <script src='js/sch/bleepsixSchematic_event.js'></script>

    <script src='js/lib/bleepsixSchBrdOp.js'></script>
    <script src='js/lib/bleepsixTabCommunication.js'></script>

    <script src='js/sch/bleepsixSchematicController.js'></script>

    <script src='js/sch/bleepsixSchematicNetwork.js'></script>

    <script src='js/brd/bleepsixBoardParameter.js'></script>

    <script src='js/brd/bleepsixBoard.js'></script>
    <script src='js/brd/bleepsixBoard_aux.js'></script>
    <script src='js/brd/bleepsixBoard_bbox.js'></script>
    <script src='js/brd/bleepsixBoard_netops.js'></script>
    <script src='js/brd/bleepsixBoard_zone.js'></script>
    <script src='js/brd/bleepsixBoard_ratsnest.js'></script>


    <script src='js/gui/guiRegion.js'></script>

    <script src='js/gui/guiPalette.js'></script>
    <script src='js/gui/guiComponentTile.js'></script>
    <script src='js/gui/guiList.js'></script>
    <script src='js/gui/guiScrollbar.js'></script>

    <script src='js/gui/guiIcon.js'></script>
    <script src='js/gui/guiDropIcon.js'></script>
    <script src='js/gui/guiToolbox.js'></script>
    <script src='js/gui/guiGrid.js'></script>
    <script src='js/gui/guiTextbox.js'></script>
    <script src='js/gui/guiAction.js'></script>


    <script src='js/gui/guiLibrary.js'></script>



    <script src='js/schtool/toolBase.js'></script>
    <script src='js/schtool/toolNav.js'></script>
    <script src='js/schtool/toolMove.js'></script>
    <script src='js/schtool/toolSelect.js'></script>
    <script src='js/schtool/toolWire.js'></script>
    <script src='js/schtool/toolConn.js'></script>
    <script src='js/schtool/toolLabel.js'></script>
    <script src='js/schtool/toolLabelEdit.js'></script>

    <script src='js/tool/toolScrollbar.js'></script>

    <script src='js/schtool/toolComponentPlace.js'></script>
    <script src='js/schtool/toolComponentEdit.js'></script>

    <script src='js/helperFunctions.js'></script>



    <link rel="shortcut icon" href="/simpleoutline.ico" />
    <link rel="icon" href="/simpleoutline.ico" />


    <style>
      body {
        padding: 0px 0px 0px 0px;
        margin: 0;
        width: 100%;
        height: 100%;
        overflow:hidden;
      }

      .file_button_container,
      .file_button_container input {
        position: absolute;
        height: 20px;
        width: 100px;
        z-index: 1;
      }

      .file_button_container {
        opacity: 0.1;
        background: #0000ff left top no-repeat; 
      }

      .file_button_container input {
        opacity: 0;
      }

      .upload_button {
        /* opacity: 0.3; */
        opacity: 0.0;
        position: absolute;
        background: transparent url(img/upload.png) left top ; 
        background-size: 32px 32px;
        background-repeat: no-repeat;
        z-index: 1;

        /*
        height: 32px;
        width: 32px;
        */
        height: 0px;
        width: 0px;
      }

      .download_button
      {
        opacity: 0.55;
        position: absolute;
        z-index: 1;

        /*
        background: transparent url(img/download.png) left top ; 
        background-size: 32px 32px;
        background-repeat: no-repeat;
        height: 32px;
        width: 32px;
        */
      }

      .upload_button input  {
        opacity: 0.0;
        position: absolute;
        /* background: transparent url(http://i.stack.imgur.com/BT5AB.png) left top no-repeat; */
        background: #0000ff left top no-repeat; 
        z-index: 1;

        height: 32px;
        width: 32px;
      }

      .generic_button {
        opacity: 0.5;
        z-index: 1;
        position: absolute;
      }

      .snapshot_button {
        opacity: 0.3;

        /*
        background: transparent url(img/camera.png) left top ;
        background-size: 20px 20px;
        background-repeat: no-repeat;
        height: 20px;
        width: 20px;
        */
        z-index: 1;
        position: absolute;
      }

    </style>

    <script src='js/meowconfig.js'></script>
    <script>

    var drawing = true,
      running = true,
      mouseDown = false,
      visible = true;

    var msec = 0;
    var frame = 0;
    var lastTime = new Date();

    var g_snapgrid = null;
    var g_painter = null;
    var g_schematic_controller = null;
    var g_controller = null;

    var g_imgcache = null;


    var g_canvas = "canvas";
    var g_context = null;

    var g_schnetwork = null;

    var g_show_fps = false;

    function canvasFocus()
    {
      //console.log("canvas focus");
      var c = document.getElementById("canvas");
      c.focus();
    }

    function position_html_button_elements(w, h) {
      var top = [ "3px", "0px", "0px", "0px" ];
      var tf = [ 0, 0, 0, 0 ];
      console.log(w,h);

      var left = [ "0px", "50px", "100px", "150px" ];
      var base_left = [ 500, 700, 750, 900 ];

      for (var i=0; i<base_left.length; i++) {
        var offset = (1200-w);
        if (offset < 0) offset = 0;
        left[i] = String( base_left[i] - offset ) + 'px';
      }

      if (w<1000) {
        top = [ "38px", "35px", "35px", "35px" ];
        left = [ "70px", "100px", "130px", "180px"  ]
      }

      ele = document.getElementById('homeButton');
      ele.style.top = top[0];
      ele.style.left = left[0];

      var ele = document.getElementById('uploadButton');
      ele.style.top = top[1];
      ele.style.left = left[1];

      ele = document.getElementById('downloadButton');
      ele.style.top = top[2];
      ele.style.left = left[2];

      ele = document.getElementById('snapButton');
      ele.style.top = top[3];
      ele.style.left = left[3];

    }


    function loop() {

      frame = frame + 1;
      if ( frame >= 30 ) {
        var d = new Date();
        msec = (d.getTime() - lastTime ) / frame;
        lastTime = d;
        frame = 0;
      }

      if (g_show_fps) 
      {
        var container = document.querySelector( 'section' );
        container.innerHTML = "FPS: " + (1000.0/msec);
      }

      var saved_dirty = g_painter.dirty_flag;

      g_schematic_controller.redraw();
      requestAnimationFrame( loop, 1 );
    }

    $(document).ready( function() {

      //???
      bleepsixBoardHeadless = true;

      meowmeow();

      var cvs = document.getElementById('canvas');
      cvs.onselectstart = function() { return false; }

      g_snapgrid = new snapGrid(true, "deci-mil", 50);

      g_painter = new bleepsixRender( "canvas" );
      g_painter.setGrid ( 1 );

      g_schematic_controller = new bleepsixSchematicController();
      g_schematic_controller.init( "canvas" );
      g_context = g_schematic_controller.context;

      g_controller = g_schematic_controller;


      // EXPERIMENTAL
      g_schematic_controller.schematic.setLocalComponentCache( g_component_cache );


      // setup image cache and preload some generic items
      //
      var img_base = "img";
      g_imgcache = new imageCache();
      g_imgcache.add( "cursor", img_base + "/cursor_custom_base_s24.png" );
      g_imgcache.add( "cursor:wire", img_base + "/cursor_custom_wire_s24.png" );
      g_imgcache.add( "cursor:bus", img_base + "/cursor_custom_bus_s24.png" );
      g_imgcache.add( "cursor:conn", img_base + "/cursor_custom_conn_s24.png" );
      g_imgcache.add( "cursor:noconn", img_base + "/cursor_custom_noconn_s24.png" );

      requestAnimationFrame( loop, 1 );


      /*
      var userId = $.cookie('userId');
      var sessionId = $.cookie('sessionId');
      var projectId = $.cookie('recentProjectId');
      */
      var userId = ( g_schnetwork ? g_schnetwork.userId : undefined );
      var sessionId = ( g_schnetwork ? g_schnetwork.sessionId : undefined );
      var projectId = ( g_schnetwork ? g_schnetwork.projectId : undefined );

      if ( (typeof userId !== "undefined") &&
           (typeof sessionId !== "undefined") &&
           (typeof projectId !== "undefined") )
      {
        load_component_location( userId, sessionId, projectId );
        load_footprint_location( userId, sessionId, projectId );
      }
      else
      {
        load_component_location();
        load_footprint_location();
      }


      position_html_button_elements( 1200, 700 );
      /*
      var f = document.getElementById('uploadButton');
      f.style.top = '0px';
      f.style.left = '500px';

      var f = document.getElementById('downloadButton');
      f.style.top = '0px';
      f.style.left = '550px';


      var f = document.getElementById('snapButton');
      f.style.top = '0px';
      f.style.left = '750px';

      var f = document.getElementById('homeButton');
      f.style.top = '4px';
      f.style.left = '900px';
      */


      // camera snapshot

      $( "#snapElement" ).hover(

        function() {
          g_schematic_controller.drawSnapArea = true;
          g_painter.dirty_flag = true;
        },

        function() {
          g_schematic_controller.drawSnapArea = false;
          g_painter.dirty_flag = true;
        }

      );


      //console.log("starting network");

      //g_schnetwork = new bleepsixSchematicNetwork();
      //g_schnetwork = new bleepsixSchematicNetwork( "https://www.meowcad.com" );
      g_schnetwork = new bleepsixSchematicNetwork( MEOWURL );

      canvasFocus();

      var w = $(window).width();
      var h = $(window).height();
      var canv = document.getElementById('canvas');
      canv.width = w;
      canv.height = h;
      g_painter.setWidthHeight( w, h );

      $(window).resize( function(ee) {
        var w = $(window).width();
        var h = $(window).height();
        var canv = document.getElementById('canvas');
        canv.width = w;
        canv.height = h;
        g_painter.setWidthHeight( w, h );

        position_html_button_elements( w, h );
        g_schematic_controller.resize(ee);
      });


    });

    if ( !window.requestAnimationFrame ) {
        window.requestAnimationFrame = ( function() {
          return window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame ||
          window.oRequestAnimationFrame ||
          window.msRequestAnimationFrame ||
          function( callback, element ) {
            window.setTimeout( callback, 1000 );
          };
        } )();
    }

    function schJSONDownload( json_container )
    {

      var msg_type = json_container["type"];
      if (msg_type != "id")
      {
        console.log("error, expected id, got: " + msg_type);
        console.log(json_container);
        return;
      }

      // fiddle with iframe to send a download request
      //
      var id = json_container["id"];
      var ifrm = document.getElementById( "downloadFrame" );
      ifrm.src = "bleepsixDownloadManager.py?id=" + id;

    }


    function uploadSchematic( )
    {
    }


    function initiateDownload( json_container )
    {
      var msg_type = json_container["type"];
      if (msg_type != "id")
      {
        console.log("error, expected id, got: " + msg_type);
        console.log(json_container);
        return;
      }

      // fiddle with iframe to send a download request
      //
      var id = json_container["id"];
      var ifrm = document.getElementById( "downloadFrame" );

      url = "bleepsixDownloadManager.py?id=" + id;
      if ("name" in json_container)
      {
        url += '&name=' + json_container["name"]
      }
      ifrm.src = url;
    }


    function downloadSchematic( )
    {
      var json_data = g_schematic_controller.schematic.kicad_sch_json ;

      var container = { "type" : "createKiCADSchematic", data: json_data };
      var str_data = JSON.stringify( container );

      $.ajax({
        url: "bleepsixDataManager.py",
        type: 'POST',
        data: str_data,
        success: schJSONDownload,
        error: function(jqxhr, status, err) { console.log(jqxhr); console.log(status); console.log(err); }

        });
    }

    function downloadProject( )
    {
      var sch_data = g_schematic_controller.schematic.kicad_sch_json ;
      var brd_data = g_schematic_controller.board.kicad_brd_json ;

      var container = { "type" : "downloadProject", board: brd_data, schematic: sch_data };
      var str_data = JSON.stringify( container );

      $.ajax({
        url: "bleepsixDataManager.py",
        type: 'POST',
        data: str_data,
        success: initiateDownload,
        error: function(jqxhr, status, err) { console.log(jqxhr); console.log(status); console.log(err); }

      });
    }

    function populateIframe(id,path)
    {
      var ifrm = document.getElementById(id);
      ifrm.src = "bleepsixDownloadManager.php?path=" + path;
    }

    function uploadComplete(x)
    {
      var json_data = JSON.parse( this.response  );
      if ( json_data["type"] == "error" )
      {
        console.log("error..." + json_data["message"] );
      }
      else
      {
        g_schematic_controller.schematic.load_schematic( json_data );
        g_schematic_controller.schematicUpdate = true;
      }
    }

    function uploadError()
    {
      console.log("upload error");
    }

    function uploadAbort()
    {
      console.log("upload abort");
    }

    function uploadProgress()
    {
      console.log("upload progress");
    }


    function sendFile( file )
    {

      console.log("file:");
      console.log(file);

      var formData = new FormData();
      formData.append( "fileType", "sch" );
      formData.append( "fileData", file );
      console.log(formData);

      var uri = "bleepsixUploadManager.py";
      var xhr = new XMLHttpRequest();
      xhr.upload.addEventListener("progress", uploadProgress, false );
      xhr.addEventListener("load", uploadComplete, false );
      xhr.addEventListener("error", uploadError, false );
      xhr.addEventListener("abort", uploadAbort, false );

      xhr.open( "POST", uri );
      xhr.send( formData );

    }

    function handleFiles( files )
    {
      var n = files.length;
      for (var i=0; i<n; i++)
        sendFile(files[i]);

      canvasFocus();
    }

    function foo( files)
    {
      console.log("foo");
      console.log(files);
    }

    </script>
  </head>

  <body>

    <!-- download hacking -->
    <iframe id='downloadFrame' style='display:none'>
    </iframe>

    <!--
    <div class="upload_button" id='uploadButton'> 
      <input 
        class='upload_button' 
        id='fileElement' 
        type="file" 
        onchange="handleFiles(this.files); canvasFocus();" 
        onclick="this.value=null;"  />
    </div>
    -->
    <div class="upload_button" id='uploadButton'> 
      <input 
        class='upload_button' 
        id='fileElement' 
        type="hidden" 
        onchange="handleFiles(this.files); canvasFocus();" 
        onclick="this.value=null;"  />
    </div>

    <div class="download_button" id='downloadButton'> 
      <input 
        class='download_button' 
        type="image" 
        src='img/download.png' 
        style=' height:32px; width:32px;' 
        value='download' 
        onclick="downloadProject(); canvasFocus();"  />
    </div>

    <!-- <div class="file_button_container" id="snapButton"> -->
    <div class="snapshot_button" id="snapButton"> 
      <!-- <input id='snapElement' type='button' value="click me" onclick="takeSnapShotPicture();" /> -->
      <input 
        id='snapElement' 
        type='image' 
        src='img/camera.png' 
        style=' height: 32px; width: 32px;' 
        value="click me" 
        onclick="canvasFocus(); takeSnapShotPicture();" /> 
    </div>

    <div class="generic_button" id='homeButton'> 
      <input 
        class='generic_button' 
        type="image" 
        src='img/kitty_head_black_outline_p32.png' 
        style=' height:26px; width:26px;' 
        value'download' 
        onclick="canvasFocus(); goHome();"  />
    </div>

    <canvas 
      id='canvas' 
      width='1200' height='700' 
      style='position: absolute; left: 0; top: 0; border:1px solid #111; z-index:0;' 
      tabindex='0'> </canvas>

  <section style='position: absolute; left: 20px; top: 720px; ' ></section>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["trackPageView"]);
  _paq.push(["enableLinkTracking"]);

  (function() {
    var u=(("https:" == document.location.protocol) ? "https" : "http") + "://meowcad.com/analytics/piwik/";
    _paq.push(["setTrackerUrl", u+"piwik.php"]);
    _paq.push(["setSiteId", "1"]);
    var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";
    g.defer=true; g.async=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Piwik Code -->

  </body>

</html>
