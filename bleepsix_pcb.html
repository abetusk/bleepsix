<html>

  <meta charset='utf-8'>

  <head>

    <!-- we don't want it pausing while loading if the server is down -->
    <link rel="shortcut icon" href="/simpleoutline.ico" />
    <link rel="icon" href="/simpleoutline.ico" />


    <!-- we don't want it pausing while loading if the server is down -->
    <script src='js/lib/socket.io.js'></script>

    <script src='js/lib/union-find.js'></script>
    <script src='js/lib/delaunay.js'></script>
    <script src='js/lib/kruskal.js'></script>
    <script src='js/lib/euclideanmst.js'></script>

    <script src='js/lib/peg.js'></script>

    <script src='js/lib/jquery.js'></script>
    <script src='js/lib/jquery.mousewheel.js'/></script>
    <script src='js/lib/jquery.capslockstate.js'/></script>
    <script src='js/lib/jquery.cookie.js'/></script>
    <script src='js/lib/jquery.getUrlParam.js'/></script>

    <script src='js/lib/numeric.js'></script>
    <script src='js/lib/oop.js'></script>

    <script src='js/lib/aux.js'></script>
    <script src='js/lib/snapGrid.js'></script>

    <script src='js/lib/clipper.js'></script>
    <script src='js/lib/bleepsixSchBrdOp.js'></script>
    <script src='js/lib/bleepsixTabCommunication.js'></script>

    <script src='js/core/bleepsixRender.js'></script>

    <script src='js/brd/bleepsixBoardParameter.js'></script>

    <script src='js/brd/bleepsixBoard.js'></script>
    <script src='js/brd/bleepsixBoard_aux.js'></script>
    <script src='js/brd/bleepsixBoard_bbox.js'></script>
    <script src='js/brd/bleepsixBoard_netops.js'></script>
    <script src='js/brd/bleepsixBoard_zone.js'></script>
    <script src='js/brd/bleepsixBoard_ratsnest.js'></script>

    <script src='js/brd/bleepsixBoardController.js'></script>
    <script src='js/brd/bleepsixBoardNetwork.js'></script>
    <script src='js/brd/bleepsixBoardParameter.js'></script>

    <script src='js/sch/bleepsixSchematic.js'></script>
    <script src='js/sch/bleepsixSchematic_event.js'></script>
    <script src='js/sch/bleepsixSchematic_net.js'></script>


    <script src='js/gui/guiRegion.js'></script>

    <script src='js/gui/guiFootprintTile.js'></script>
    <script src='js/gui/guiList.js'></script>
    <script src='js/gui/guiScrollbar.js'></script>

    <script src='js/gui/guiIcon.js'></script>
    <script src='js/gui/guiDropIcon.js'></script>
    <script src='js/gui/guiGrid.js'></script>
    <script src='js/gui/guiTextbox.js'></script>
    <script src='js/gui/guiAction.js'></script>


    <script src='js/gui/guiFootprintLibrary.js'></script>
    <script src='js/gui/guiBoardToolbox.js'></script>
    <script src='js/gui/guiBoardLayer.js'></script>
    <script src='js/gui/guiLayer.js'></script>

    <script src='js/tool/toolScrollbar.js'></script>

    <script src='js/brdtool/toolBoardNav.js'></script>
    <script src='js/brdtool/toolTrace.js'></script>
    <script src='js/brdtool/toolEdge.js'></script>
    <script src='js/brdtool/toolEdgeShape.js'></script>
    <script src='js/brdtool/toolFootprintPlace.js'></script>
    <script src='js/brdtool/toolBoardMove.js'></script>
    <script src='js/brdtool/toolBoardSelect.js'></script>
    <script src='js/brdtool/toolBoardZone.js'></script>

    <script src='js/helperFunctions.js'></script>

    <style>
      .file_button_container,
      .file_button_container input {
        position: absolute;
        height: 20px;
        width: 100px;
        z-index: 1;
      }

      .file_button_container {
        opacity: 0.1;
        background: #0000ff left top no-repeat;
      }

      .file_button_container input {
        opacity: 0;
      }

      .upload_button {
        opacity: 0.3;
        position: absolute;
        background: transparent url(img/upload_white.png) left top ;
        background-size: 32px 32px;
        background-repeat: no-repeat;
        z-index: 1;

        height: 32px;
        width: 32px;
      }

      .download_button
      {
        opacity: 0.55;
        position: absolute;
        z-index: 1;
      }

      .upload_button input  {
        opacity: 0.0;
        position: absolute;
        /* background: transparent url(http://i.stack.imgur.com/BT5AB.png) left top no-repeat; */
        background: #0000ff left top no-repeat;
        z-index: 1;

        height: 32px;
        width: 32px;
      }

      .generic_button {
        opacity: 0.55;
        z-index: 1;
        position: absolute;
      }

      .snapshot_button {
        opacity: 0.3;
        z-index: 1;
        position: absolute;
      }

    </style>



    <script>

      //var MEOWURL = "https://www.meowcad.com";
      var MEOWURL = "https://localhost";

	  var drawing = true,
	      running = true,
	      mouseDown = false,
	      visible = true;
	  
	  var g_msec = 1;
	  var frame = 0;
	  var lastTime = new Date();
	  
      var g_snapgrid = null;
	  var g_painter = null;
      var g_board_controller = null; 

      var g_brdnetwork = null;
      var g_controller = null;
      //var g_parameter = null;

      var g_imgcache = null;

      var g_canvas = "canvas";
      var g_context = null;


      function canvasFocus()
      {
        //console.log("canvas focus");
        var c = document.getElementById("canvas");
        c.focus();
      }

	  function loop() {
		
		frame = frame + 1;
		if ( frame >= 30 ) {
			var d = new Date();
			g_msec = (d.getTime() - lastTime ) / frame;
			lastTime = d;
			frame = 0;
		}
		var container = document.querySelector( 'section' );
		container.innerHTML = "FPS: " + (1000.0/g_msec);

			
		g_board_controller.redraw();
		//requestAnimationFrame( loop, 1 );		
		requestAnimationFrame( loop );
	  }

      $(document).ready( function() {
        //console.log("ready");

        meowmeow();

        var cvs = document.getElementById('canvas');
        cvs.onselectstart = function() { return false; }

        //g_parameter = new bleepsixBoardParameter();

        g_snapgrid = new snapGrid(true, "deci-mil", 50);

		g_painter = new bleepsixRender( "canvas" );
        g_painter.setGrid ( 1 );

        g_board_controller = new bleepsixBoardController();
        g_board_controller.init( "canvas" );		
		g_context = g_board_controller.context;

        g_controller = g_board_controller;


        var img_base = "img";
        g_imgcache = new imageCache();
        g_imgcache.add( "cursor", img_base + "/cursor_custom_base_s24.png" );
        g_imgcache.add( "cursor:wire", img_base + "/cursor_custom_wire_s24.png" );
        g_imgcache.add( "cursor:bus", img_base + "/cursor_custom_bus_s24.png" );
        g_imgcache.add( "cursor:conn", img_base + "/cursor_custom_conn_s24.png" );
        g_imgcache.add( "cursor:noconn", img_base + "/cursor_custom_noconn_s24.png" );


		requestAnimationFrame( loop, 1 );

        /*
        var userId = $.cookie("userId");
        var sessionId = $.cookie("sessionId");
        var projectId = $.cookie("recentProjectId");
        */
        var userId = ( g_brdnetwork ? g_brdnetwork.userId : undefined );
        var sessionId = ( g_brdnetwork ? g_brdnetwork.sessionId : undefined );
        var projectId = ( g_brdnetwork ? g_brdnetwork.projectId : undefined );


        if ( (typeof userId !== "undefined") && 
             (typeof sessionId !== "undefined") &&
             (typeof projectId !== "undefined") )
        {
          load_footprint_location( userId, sessionId, projectId );
          load_component_location( userId, sessionId, projectId );
        }
        else
        {
          load_footprint_location();
          load_component_location();
        }

        var f = document.getElementById('uploadButton');
        f.style.top = '0px';
        f.style.left = '500px';

        var f = document.getElementById('downloadButton');
        f.style.top = '0px';
        f.style.left = '550px';


        var f = document.getElementById('snapButton');
        f.style.top = '0px';
        f.style.left = '750px';

        var f = document.getElementById('homeButton');
        f.style.top = '4px';
        f.style.left = '900px';


        // camera snapshot
        //
        $( "#snapElement" ).hover(
        function() {
          g_board_controller.drawSnapArea = true;
          g_painter.dirty_flag = true;
        },
        function() {
          g_board_controller.drawSnapArea = false;
          g_painter.dirty_flag = true;
        }
        );


        //g_brdnetwork = new bleepsixBoardNetwork();
        //g_brdnetwork = new bleepsixBoardNetwork( "https://www.meowcad.com" );
        g_brdnetwork = new bleepsixBoardNetwork( MEOWURL );

        canvasFocus();

      });
	  
	  if ( !window.requestAnimationFrame ) {
		  window.requestAnimationFrame = ( function() {
			
			return window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function( callback, element ) {
			  window.setTimeout( callback, 1000 );
			};
			
		  } )();
		}

      function btn_func()
      {
        console.log("btn_func");

        var brd_file = "examples/osh_heart_v2_brd.json";
        //var brd_file = "examples/display_test_brd.json";
        //var brd_file = "examples/net_test_brd.json";
        //var brd_file = "examples/net_test2_brd.json";
        //var brd_file = "examples/net_test_thermal_relief_brd.json";
        //var brd_file = "examples/zone_test_brd.json";
        var brd = g_board_controller.board;

        $.ajaxSetup({ cache: false });
        $.getJSON( brd_file,
          function(data) { 
            console.log("data:")
            console.log(data); 
            g_board_controller.board.load_board(data); 
          }).fail(
           ( function(a) {
             return function(jqxhr, textStatus,error) {
               brd.load_board_error(a, jqxhr, textStatus, error);
             }
           })(brd_file)
          );
      }

      function brdJSONDownload( json_container )
      {
        var msg_type = json_container["type"];
        if (msg_type != "id")
        {
          console.log("error, expected id, got: " + msg_type);
          console.log(json_container);
          return;
        }

        // fiddle with iframe to send a download request
        //
        var id = json_container["id"];
        var ifrm = document.getElementById( "downloadFrame" );

        //ifrm.src = "bleepsixDownloadManager.py?id=" + id;
        url = "bleepsixDownloadManager.py?id=" + id;
        if ("name" in json_container)
        {
          url += '&name=' + json_container["name"]
        }
        ifrm.src = url;
      }

      function initiateDownload( json_container )
      {
        var msg_type = json_container["type"];
        if (msg_type != "id")
        {
          console.log("error, expected id, got: " + msg_type);
          console.log(json_container);
          return;
        }

        // fiddle with iframe to send a download request
        //
        var id = json_container["id"];
        var ifrm = document.getElementById( "downloadFrame" );
        //ifrm.src = "bleepsixDownloadManager.py?id=" + id;

        url = "bleepsixDownloadManager.py?id=" + id;
        if ("name" in json_container)
        {
          url += '&name=' + json_container["name"]
        }
        ifrm.src = url;
      }

      function downloadBoard( )
      {
        var json_data = g_board_controller.board.kicad_brd_json ;

        var container = { "type" : "createKiCADBoard", data: json_data };
        var str_data = JSON.stringify( container );

        $.ajax({
          url: "bleepsixDataManager.py",
          type: 'POST',
          data: str_data,
          success: brdJSONDownload,
          error: function(jqxhr, status, err) { console.log(jqxhr); console.log(status); console.log(err); }

          });
      }

      function downloadProject( )
      {
        var brd_data = g_board_controller.board.kicad_brd_json ;
        var sch_data = g_board_controller.schematic.kicad_sch_json ;

        var container = { "type" : "downloadProject", board: brd_data, schematic: sch_data };
        var str_data = JSON.stringify( container );

        $.ajax({
          url: "bleepsixDataManager.py",
          type: 'POST',
          data: str_data,
          success: initiateDownload,
          error: function(jqxhr, status, err) { console.log(jqxhr); console.log(status); console.log(err); }

          });
      }

      function populateIframe(id,path)
      {
        var ifrm = document.getElementById(id);
        ifrm.src = "bleepsixDownloadManager.php?path=" + path;
      }

      function uploadComplete(x)
      {
        var json_data = JSON.parse( this.response  );
        if ( json_data["type"] == "error" )
        {
          console.log("error..." + json_data["message"] );
        }
        else
        {
          g_board_controller.board.load_board( json_data );
          g_board_controller.boardUpdate = true;
        }
      }


      function uploadError()
      {
        console.log("upload error");
      }

      function uploadAbort()
      {
        console.log("upload abort");
      }

      function uploadProgress()
      {
        console.log("upload progress");
      }


      function sendFile( file )
      {

        console.log("file:");
        console.log(file);

        var formData = new FormData();
        formData.append( "fileType", "sch" );
        formData.append( "fileData", file );
        console.log(formData);

        var uri = "bleepsixUploadBoardManager.py";
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener("progress", uploadProgress, false );
        xhr.addEventListener("load", uploadComplete, false );
        xhr.addEventListener("error", uploadError, false );
        xhr.addEventListener("abort", uploadAbort, false );

        xhr.open( "POST", uri );
        xhr.send( formData );

      }


      function handleFiles( files )
      {
        var n = files.length;
        for (var i=0; i<n; i++)
          sendFile(files[i]);

        canvasFocus();
      }

    </script>
  </head>
  <body>

    <!-- download hacking -->
    <iframe id='downloadFrame' style='display:none'>
    </iframe>

    <div class="upload_button" id='uploadButton'>
      <input 
        class='upload_button' 
        id='fileElement' 
        type="file" 
        onchange="handleFiles(this.files); canvasFocus();" 
        onclick="this.value=null;"  />
    </div>

    <div class="download_button" id='downloadButton'>
      <input 
        class='download_button' 
        type="image" 
        src='img/download_white.png' 
        style=' height:32px; width:32px;' 
        value='download' 
        onclick="downloadProject(); canvasFocus();"  />
    </div>
    <!-- onclick="downloadBoard(); canvasFocus();"  /> -->

    <div class="snapshot_button" id="snapButton">
      <input 
        id='snapElement' 
        type='image' 
        src='img/camera_white.png' 
        style=' height: 32px; width: 32px;' 
        value="click me" 
        onclick="canvasFocus(); takeSnapShotPicture();" />
    </div>

    <div class="generic_button" id='homeButton'>
      <input 
        class='generic_button' 
        type="image" 
        src='img/kitty_head_white_outline_p32.png' 
        style=' height:26px; width:26px;' 
        value'download' 
        onclick="canvasFocus(); goHome();"  />
    </div>



    <canvas 
      id='canvas' 
      width='1200' height='700' 
      style='position:absolute; left: 0; top: 0; border:1px solid #111; z-index:0;' 
      tabindex='0'> 
    </canvas>

	<section  style='position: absolute; left: 20px; top: 720px; '></section>

    <!-- 
    <button 
      style='position: absolute; left: 20px; top: 740px; ' 
      id='btn' 
      onclick='btn_func();' 
    >
      f
    </button>
    -->

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["trackPageView"]);
  _paq.push(["enableLinkTracking"]);

  (function() {
    var u=(("https:" == document.location.protocol) ? "https" : "http") + "://meowcad.com/analytics/piwik/";
    _paq.push(["setTrackerUrl", u+"piwik.php"]);
    _paq.push(["setSiteId", "1"]);
    var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";
    g.defer=true; g.async=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Piwik Code -->

  </body>

</html>
